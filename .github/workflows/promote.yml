name: Promote to Production

on:
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Image tag to promote (full SHA from dev)'
        required: true
      confirm:
        description: 'Type "yes" to confirm production deployment'
        required: true

jobs:
  promote:
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm == 'yes'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate image exists
        run: |
          echo "Checking if image exists..."
          docker manifest inspect ${{ secrets.DOCKERHUB_USERNAME }}/asutp-collector:${{ github.event.inputs.image_tag }} || {
            echo "❌ Image not found: ${{ secrets.DOCKERHUB_USERNAME }}/asutp-collector:${{ github.event.inputs.image_tag }}"
            exit 1
          }
          echo "✅ Image found"
        env:
          DOCKER_CLI_EXPERIMENTAL: enabled

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Update Kustomization (prod)
        run: |
          # Update prod overlay with specified image tag
          sed -i "s|newTag:.*|newTag: ${{ github.event.inputs.image_tag }}|g" asutp/overlays/prod/kustomization.yaml

          # Verify change
          echo "Updated prod kustomization:"
          cat asutp/overlays/prod/kustomization.yaml

      - name: Commit and Push
        run: |
          git config user.email "ci-bot@example.com"
          git config user.name "CI Bot"

          if [[ -n $(git status --porcelain) ]]; then
            git add asutp/overlays/prod/kustomization.yaml
            git commit -m "promote: asutp-collector to prod with tag ${{ github.event.inputs.image_tag }}"
            git push
            echo "✅ Production manifest updated"
          else
            echo "⚠️ No changes in manifest (already at this version?)"
          fi

      - name: Summary
        run: |
          echo "## Promotion Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Parameter | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Image Tag | \`${{ github.event.inputs.image_tag }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | \`prod\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Triggered by | @${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ArgoCD will automatically sync the changes." >> $GITHUB_STEP_SUMMARY
